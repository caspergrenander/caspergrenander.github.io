<!DOCTYPE html> 
<html lang="en">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>AutoPublisher ‚Äì Direct Post</title>  
  <style>  
    * {  
      margin: 0;  
      padding: 0;  
      box-sizing: border-box;  
    }  body {  
  background: #1A2838;  
  color: #F5E5C8;  
  font-family: "Segoe UI", Roboto, Arial, sans-serif;  
  line-height: 1.6;  
}  

header {  
  padding: 40px 20px;  
  text-align: center;  
  background: #0D0F15;  
  border-bottom: 1px solid #2A4A4A;  
}  

header img {  
  width: 160px;  
  border-radius: 6px;  
  margin-bottom: 15px;  
}  

h1 {  
  color: #FFFFFF;  
  font-weight: 600;  
  font-size: 24px;  
}  

.container {  
  max-width: 800px;  
  margin: 40px auto;  
  padding: 0 20px;  
}  

.card {  
  background: #0D0F15;  
  border: 1px solid #2A4A4A;  
  border-radius: 8px;  
  padding: 30px;  
}  

.creator-section {  
  background: rgba(232, 182, 92, 0.1);  
  border: 1px solid #E8B65C;  
  border-radius: 8px;  
  padding: 20px;  
  margin-bottom: 30px;  
  display: flex;  
  align-items: center;  
  gap: 20px;  
}  

.creator-avatar {  
  width: 60px;  
  height: 60px;  
  border-radius: 50%;  
  background: #2A4A4A;  
  display: flex;  
  align-items: center;  
  justify-content: center;  
  font-size: 24px;  
  color: #FFFFFF;  
}  

.creator-details {  
  flex: 1;  
}  

.creator-username {  
  font-size: 20px;  
  font-weight: 600;  
  color: #FFFFFF;  
  margin-bottom: 5px;  
}  

.creator-stats {  
  color: #2A4A4A;  
  font-size: 14px;  
}  

.upload-area {  
  border: 2px dashed #2A4A4A;  
  border-radius: 8px;  
  padding: 40px 20px;  
  text-align: center;  
  margin: 20px 0;  
  cursor: pointer;  
  transition: all 0.2s ease;  
}  

.upload-area:hover {  
  border-color: #E8B65C;  
  background: rgba(232, 182, 92, 0.05);  
}  

.upload-icon {  
  font-size: 48px;  
  color: #2A4A4A;  
  margin-bottom: 15px;  
}  

.file-info {  
  background: rgba(42, 74, 74, 0.2);  
  padding: 15px;  
  border-radius: 6px;  
  margin: 20px 0;  
  border-left: 4px solid #E8B65C;  
}  

.video-preview {  
  width: 100%;  
  max-width: 400px;  
  margin: 20px auto;  
  display: block;  
  border-radius: 8px;  
  border: 2px solid #2A4A4A;  
}  

.form-group {  
  margin-bottom: 25px;  
}  

label {  
  display: block;  
  margin-bottom: 8px;  
  color: #FFFFFF;  
  font-weight: 500;  
}  

textarea {  
  width: 100%;  
  padding: 12px;  
  background: rgba(42, 74, 74, 0.2);  
  border: 1px solid #2A4A4A;  
  border-radius: 6px;  
  color: #F5E5C8;  
  font-family: inherit;  
  font-size: 15px;  
  resize: vertical;  
  min-height: 100px;  
}  

textarea:focus {  
  outline: none;  
  border-color: #E8B65C;  
}  

select {  
  width: 100%;  
  padding: 12px;  
  background: rgba(42, 74, 74, 0.2);  
  border: 1px solid #2A4A4A;  
  border-radius: 6px;  
  color: #F5E5C8;  
  font-size: 15px;  
  cursor: pointer;  
}  

select:focus {  
  outline: none;  
  border-color: #E8B65C;  
}  

select option {  
  background: #0D0F15;  
  color: #F5E5C8;  
}  

select:disabled {  
  opacity: 0.5;  
  cursor: not-allowed;  
}  

.checkbox-group {  
  background: rgba(42, 74, 74, 0.1);  
  border: 1px solid #2A4A4A;  
  border-radius: 6px;  
  padding: 15px;  
}  

.checkbox-item {  
  display: flex;  
  align-items: center;  
  gap: 10px;  
  margin: 10px 0;  
}  

.checkbox-item input[type="checkbox"] {  
  width: 18px;  
  height: 18px;  
  cursor: pointer;  
}  

.checkbox-item input[type="checkbox"]:disabled {  
  opacity: 0.3;  
  cursor: not-allowed;  
}  

.checkbox-item label {  
  margin: 0;  
  cursor: pointer;  
}  

.checkbox-item label.disabled {  
  opacity: 0.5;  
  cursor: not-allowed;  
}  

.commercial-section {  
  background: rgba(216, 139, 92, 0.1);  
  border: 1px solid #D88B5C;  
  border-radius: 6px;  
  padding: 15px;  
}  

.commercial-toggle {  
  display: flex;  
  align-items: center;  
  gap: 10px;  
  margin-bottom: 15px;  
}  

.commercial-options {  
  margin-left: 28px;  
  display: none;  
}  

.commercial-options.show {  
  display: block;  
}  

.button {  
  background: #E8B65C;  
  color: #1A2838;  
  border: none;  
  padding: 14px 28px;  
  border-radius: 6px;  
  font-size: 16px;  
  font-weight: 600;  
  cursor: pointer;  
  transition: all 0.2s ease;  
  width: 100%;  
}  

.button:hover:not(:disabled) {  
  background: #F5C97C;  
  transform: translateY(-1px);  
}  

.button:disabled {  
  opacity: 0.5;  
  cursor: not-allowed;  
}  

.status {  
  margin-top: 20px;  
  padding: 15px;  
  border-radius: 6px;  
  text-align: center;  
  display: none;  
}  

.status.show {  
  display: block;  
}  

.status.success {  
  background: rgba(232, 182, 92, 0.15);  
  border: 2px solid #E8B65C;  
  color: #E8B65C;  
}  

.status.error {  
  background: rgba(216, 139, 92, 0.15);  
  border: 2px solid #D88B5C;  
  color: #D88B5C;  
}  

.status.processing {  
  background: rgba(42, 74, 74, 0.3);  
  border: 2px solid #2A4A4A;  
  color: #F5E5C8;  
}  

.error-message {  
  color: #D88B5C;  
  font-size: 14px;  
  margin-top: 5px;  
  display: none;  
}  

.error-message.show {  
  display: block;  
}  

.back-link {  
  display: inline-block;  
  margin-top: 30px;  
  color: #2A4A4A;  
  text-decoration: none;  
  font-size: 14px;  
}  

.back-link:hover {  
  color: #E8B65C;  
}

  </style>  
</head>  
<body>  
  <header>  
    <img src="/historienbakomusiken/historienbakomusiken/assets/logo.png" alt="Historien Bakom Musiken">  
    <h1>AutoPublisher</h1>  
  </header>    <div class="container">  
    <div class="card">  
      <!-- Creator Info - Dynamically populated from TikTok API -->  
      <div class="creator-section" id="creatorSection">  
        <div class="creator-avatar" id="creatorAvatar">üë§</div>  
        <div class="creator-details">  
          <div class="creator-username" id="creatorUsername"><?= creatorInfo?.creator_nickname ? '@' + creatorInfo.creator_nickname : 'Loading...' ?></div>  
          <div class="creator-stats" id="creatorStats">  
            <span id="creatorFollowers"><?= creatorInfo?.followers_count ?? '0' ?></span> followers  
          </div>  
        </div>  
      </div>  <!-- Upload Area -->  
  <div class="upload-area" id="uploadArea">  
    <div class="upload-icon">üìÅ</div>  
    <p>Select video to publish</p>  
    <p style="color: #2A4A4A; font-size: 14px; margin-top: 10px;">MP4, MOV, AVI (max 100MB)</p>  
  </div>  
  <input type="file" id="videoFile" accept="video/*" style="display: none">  

  <!-- File Info & Preview -->  
  <div id="fileInfo" class="file-info" style="display: none;">  
    <p><strong>Selected:</strong> <span id="fileName"></span></p>  
    <p style="color: #2A4A4A; font-size: 14px;">Size: <span id="fileSize"></span></p>  
  </div>  

  <video id="videoPreview" class="video-preview" controls style="display: none;"></video>  

  <!-- Caption -->  
  <div class="form-group">  
    <label for="caption">Caption</label>  
    <textarea id="caption" placeholder="Write your video caption..." maxlength="2200"></textarea>  
    <div style="text-align: right; font-size: 12px; color: #2A4A4A; margin-top: 5px;">  
      <span id="captionCount">0</span>/2200  
    </div>  
  </div>  

  <!-- Privacy Level - Dynamically from creatorInfo -->  
  <div class="form-group">  
    <label for="privacy">Privacy</label>  
    <select id="privacy"></select>  
  </div>  

  <!-- Interaction Controls - Reflecting creatorInfo settings -->  
  <div class="form-group">  
    <label>Interaction Settings</label>  
    <div class="checkbox-group">  
      <div class="checkbox-item">  
        <input type="checkbox" id="allowComment">  
        <label for="allowComment" id="allowCommentLabel">Allow comments</label>  
      </div>  
      <div class="checkbox-item">  
        <input type="checkbox" id="allowDuet">  
        <label for="allowDuet" id="allowDuetLabel">Allow duet</label>  
      </div>  
      <div class="checkbox-item">  
        <input type="checkbox" id="allowStitch">  
        <label for="allowStitch" id="allowStitchLabel">Allow stitch</label>  
      </div>  
    </div>  
  </div>  

  <!-- Commercial Content -->  
  <div class="form-group">  
    <div class="commercial-section">  
      <div class="commercial-toggle">  
        <input type="checkbox" id="commercialToggle">  
        <label for="commercialToggle">This contains commercial content</label>  
      </div>  
      <div class="commercial-options" id="commercialOptions">  
        <div class="checkbox-item">  
          <input type="checkbox" id="commercialYourBrand">  
          <label for="commercialYourBrand">Your Brand</label>  
        </div>  
        <div class="checkbox-item">  
          <input type="checkbox" id="commercialBranded">  
          <label for="commercialBranded">Branded Content</label>  
        </div>  
      </div>  
    </div>  
    <div class="error-message" id="commercialError">Select commercial content type</div>  
  </div>  

  <!-- Consent -->  
  <div class="form-group">  
    <div class="checkbox-item">  
      <input type="checkbox" id="consent">  
      <label for="consent">I confirm I have rights to this content</label>  
    </div>  
    <div class="error-message" id="consentError">Consent required</div>  
  </div>  

  <!-- Publish Button -->  
  <button class="button" id="publishBtn" disabled>Publish to TikTok</button>  

  <!-- Status Message -->  
  <div class="status" id="status"></div>  

  <!-- Back Link -->  
  <a href="https://caspergrenander.github.io/historienbakomusiken/projekt-info/" class="back-link">‚Üê Back</a>  
</div>

  </div>    <script>  
    // File handling  
    let selectedFile = null;  
    let publishInProgress = false;  
  
    // DOM Elements  
    const uploadArea = document.getElementById('uploadArea');  
    const videoFile = document.getElementById('videoFile');  
    const fileInfo = document.getElementById('fileInfo');  
    const fileName = document.getElementById('fileName');  
    const fileSize = document.getElementById('fileSize');  
    const videoPreview = document.getElementById('videoPreview');  
    const caption = document.getElementById('caption');  
    const captionCount = document.getElementById('captionCount');  
    const privacy = document.getElementById('privacy');  
    const allowComment = document.getElementById('allowComment');  
    const allowDuet = document.getElementById('allowDuet');  
    const allowStitch = document.getElementById('allowStitch');  
    const allowCommentLabel = document.getElementById('allowCommentLabel');  
    const allowDuetLabel = document.getElementById('allowDuetLabel');  
    const allowStitchLabel = document.getElementById('allowStitchLabel');  
    const commercialToggle = document.getElementById('commercialToggle');  
    const commercialOptions = document.getElementById('commercialOptions');  
    const commercialYourBrand = document.getElementById('commercialYourBrand');  
    const commercialBranded = document.getElementById('commercialBranded');  
    const consent = document.getElementById('consent');  
    const publishBtn = document.getElementById('publishBtn');  
    const status = document.getElementById('status');  
    const commercialError = document.getElementById('commercialError');  
    const consentError = document.getElementById('consentError');  
  
    // Creator info from server  
    const creatorInfo = <?= JSON_encode(creatorInfo) ?>;  
  
    // Initialize UI based on creatorInfo  
    function initializeFromCreatorInfo() {  
      if (!creatorInfo) return;  
  
      // 1. Render privacy options from API  
      renderPrivacyOptions();  
  
      // 2. Apply interaction settings from API  
      applyInteractionSettings();  
    }  
  
    // ‚úÖ CORRECT: Privacy options from creatorInfo.privacy_level_options  
    function renderPrivacyOptions() {  
      privacy.innerHTML = '';  
  
      if (!creatorInfo || !creatorInfo.privacy_level_options || !creatorInfo.privacy_level_options.length) {  
        // Fallback to standard options if API doesn't return any  
        const options = ['PUBLIC', 'FRIENDS', 'PRIVATE'];  
        options.forEach(level => {  
          const option = document.createElement('option');  
          option.value = level;  
          option.textContent =   
            level === 'PUBLIC' ? 'Public' :  
            level === 'FRIENDS' ? 'Friends' :  
            level === 'PRIVATE' ? 'Private' : level;  
          privacy.appendChild(option);  
        });  
        return;  
      }  
  
      creatorInfo.privacy_level_options.forEach(level => {  
        const option = document.createElement('option');  
        option.value = level;  
        option.textContent =   
          level === 'PUBLIC' ? 'Public' :  
          level === 'FRIENDS' ? 'Friends' :  
          level === 'PRIVATE' ? 'Private' : level;  
        privacy.appendChild(option);  
      });  
    }  
  
    // ‚úÖ CORRECT: Interaction settings from creatorInfo  
    function applyInteractionSettings() {  
      if (!creatorInfo) return;  
  
      // Comments  
      if (creatorInfo.comment_disabled) {  
        allowComment.checked = false;  
        allowComment.disabled = true;  
        allowCommentLabel.classList.add('disabled');  
      } else {  
        allowComment.checked = true;  
        allowComment.disabled = false;  
        allowCommentLabel.classList.remove('disabled');  
      }  
  
      // Duet  
      if (creatorInfo.duet_disabled) {  
        allowDuet.checked = false;  
        allowDuet.disabled = true;  
        allowDuetLabel.classList.add('disabled');  
      } else {  
        allowDuet.checked = false;  
        allowDuet.disabled = false;  
        allowDuetLabel.classList.remove('disabled');  
      }  
  
      // Stitch  
      if (creatorInfo.stitch_disabled) {  
        allowStitch.checked = false;  
        allowStitch.disabled = true;  
        allowStitchLabel.classList.add('disabled');  
      } else {  
        allowStitch.checked = false;  
        allowStitch.disabled = false;  
        allowStitchLabel.classList.remove('disabled');  
      }  
    }  
  
    // Upload handlers  
    uploadArea.addEventListener('click', () => videoFile.click());  
  
    uploadArea.addEventListener('dragover', (e) => {  
      e.preventDefault();  
      uploadArea.style.borderColor = '#E8B65C';  
    });  
  
    uploadArea.addEventListener('dragleave', () => {  
      uploadArea.style.borderColor = '#2A4A4A';  
    });  
  
    uploadArea.addEventListener('drop', (e) => {  
      e.preventDefault();  
      uploadArea.style.borderColor = '#2A4A4A';  
      if (e.dataTransfer.files.length) {  
        videoFile.files = e.dataTransfer.files;  
        handleFileSelect();  
      }  
    });  
  
    videoFile.addEventListener('change', handleFileSelect);  
  
    function handleFileSelect() {  
      if (videoFile.files.length) {  
        selectedFile = videoFile.files[0];  
          
        // Validate file size (100MB limit)  
        if (selectedFile.size > 100 * 1024 * 1024) {  
          showStatus('File exceeds 100MB limit', 'error');  
          videoFile.value = '';  
          selectedFile = null;  
          return;  
        }  
  
        // Show file info  
        fileName.textContent = selectedFile.name;  
        fileSize.textContent = formatFileSize(selectedFile.size);  
        fileInfo.style.display = 'block';  
  
        // Show preview  
        const url = URL.createObjectURL(selectedFile);  
        videoPreview.src = url;  
        videoPreview.style.display = 'block';  
  
        validateForm();  
      }  
    }  
  
    function formatFileSize(bytes) {  
      if (bytes === 0) return '0 Bytes';  
      const k = 1024;  
      const sizes = ['Bytes', 'KB', 'MB'];  
      const i = Math.floor(Math.log(bytes) / Math.log(k));  
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];  
    }  
  
    // Caption counter  
    caption.addEventListener('input', () => {  
      captionCount.textContent = caption.value.length;  
      validateForm();  
    });  
  
    // Commercial toggle  
    commercialToggle.addEventListener('change', function() {  
      commercialOptions.classList.toggle('show', this.checked);  
      if (!this.checked) {  
        commercialYourBrand.checked = false;  
        commercialBranded.checked = false;  
      }  
      validateForm();  
    });  
  
    // Validation listeners  
    [privacy, allowComment, allowDuet, allowStitch, commercialYourBrand,   
     commercialBranded, consent].forEach(el => {  
      el.addEventListener('change', validateForm);  
    });  
  
    function validateForm() {  
      let isValid = true;  
  
      // File required  
      if (!selectedFile) isValid = false;  
  
      // Caption required  
      if (!caption.value.trim()) isValid = false;  
  
      // Privacy required  
      if (!privacy.value) isValid = false;  
  
      // Commercial validation  
      if (commercialToggle.checked) {  
        if (!commercialYourBrand.checked && !commercialBranded.checked) {  
          commercialError.classList.add('show');  
          isValid = false;  
        } else {  
          commercialError.classList.remove('show');  
        }  
      } else {  
        commercialError.classList.remove('show');  
      }  
  
      // Consent required  
      if (!consent.checked) {  
        consentError.classList.add('show');  
        isValid = false;  
      } else {  
        consentError.classList.remove('show');  
      }  
  
      publishBtn.disabled = !isValid || publishInProgress;  
      return isValid;  
    }  
  
    // ‚úÖ CORRECT: Direct Post flow with upload_url  
    publishBtn.addEventListener('click', async () => {  
      if (!validateForm() || publishInProgress) return;  
  
      publishInProgress = true;  
      publishBtn.disabled = true;  
      showStatus('Initializing publish...', 'processing');  
  
      try {  
        // Step 1: Call init endpoint - NO video data, just metadata  
        showStatus('Requesting upload URL...', 'processing');  
          
        const initResult = await new Promise((resolve, reject) => {  
          google.script.run  
            .withSuccessHandler(resolve)  
            .withFailureHandler(reject)  
            .initDirectPost({  
              caption: caption.value.trim(),  
              privacy: privacy.value,  
              allowComment: allowComment.checked,  
              allowDuet: allowDuet.checked,  
              allowStitch: allowStitch.checked,  
              commercialContent: commercialToggle.checked ? {  
                yourBrand: commercialYourBrand.checked,  
                branded: commercialBranded.checked  
              } : null,  
              fileSize: selectedFile.size,  
              fileName: selectedFile.name  
              // ‚ö†Ô∏è NO file data here - only metadata  
            });  
        });  
  
        if (!initResult || !initResult.publish_id || !initResult.upload_url) {  
          throw new Error('Failed to initialize upload - missing upload_url');  
        }  
  
        // Step 2: Upload video binary to upload_url via PUT  
        showStatus('Uploading video...', 'processing');  
          
        const uploadResponse = await fetch(initResult.upload_url, {  
          method: 'PUT',  
          body: selectedFile,  
          headers: {  
            'Content-Type': 'video/mp4' // or detect from file  
          }  
        });  
  
        if (!uploadResponse.ok) {  
          throw new Error('Video upload failed: ' + uploadResponse.status);  
        }  
  
        // Step 3: Call complete endpoint  
        showStatus('Finalizing publish...', 'processing');  
          
        const completeResult = await new Promise((resolve, reject) => {  
          google.script.run  
            .withSuccessHandler(resolve)  
            .withFailureHandler(reject)  
            .completeDirectPost(initResult.publish_id);  
        });  
  
        // Success  
        showStatus('Published successfully!', 'success');  
          
        // Reset form  
        setTimeout(() => {  
          resetForm();  
        }, 2000);  
  
      } catch (error) {  
        console.error('Publish error:', error);  
        showStatus('Publish failed: ' + error.message, 'error');  
      } finally {  
        publishInProgress = false;  
        validateForm();  
      }  
    });  
  
    function showStatus(message, type) {  
      status.textContent = message;  
      status.className = `status show ${type}`;  
    }  
  
    function resetForm() {  
      selectedFile = null;  
      videoFile.value = '';  
      fileInfo.style.display = 'none';  
      videoPreview.style.display = 'none';  
      videoPreview.src = '';  
      caption.value = '';  
      captionCount.textContent = '0';  
        
      // Reset to API values  
      if (creatorInfo) {  
        if (creatorInfo.privacy_level_options && creatorInfo.privacy_level_options.length) {  
          privacy.value = creatorInfo.privacy_level_options[0];  
        }  
        applyInteractionSettings();  
      }  
        
      commercialToggle.checked = false;  
      commercialOptions.classList.remove('show');  
      commercialYourBrand.checked = false;  
      commercialBranded.checked = false;  
      consent.checked = false;  
      validateForm();  
    }  
  
    // Initialize  
    initializeFromCreatorInfo();  
      
    // Initial validation  
    validateForm();  
  </script>  
</body>  
</html>