<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Deletion Request – AutoPublisher</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #1A2838;
      color: #F5E5C8;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      line-height: 1.7;
    }

    header {
      padding: 60px 20px 40px;
      text-align: center;
      background: #0D0F15;
      border-bottom: 1px solid #2A4A4A;
    }

    header a {
      color: inherit;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    header img {
      width: 180px;
      border-radius: 6px;
      margin-bottom: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }

    h1 {
      color: #FFFFFF;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 22px;
    }

    h2 {
      color: #FFFFFF;
      font-weight: 600;
      margin-top: 50px;
      border-bottom: 1px solid #2A4A4A;
      padding-bottom: 10px;
    }

    p {
      max-width: 800px;
      margin: 15px auto;
      color: #F5E5C8;
    }

    a {
      color: #D88B5C;
      text-decoration: none;
      transition: color 0.2s;
    }
    a:hover {
      color: #E8B65C;
      text-decoration: underline;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: #0D0F15;
      padding: 40px 30px;
      border-radius: 6px;
      margin-top: 40px;
      margin-bottom: 40px;
      border: 1px solid #2A4A4A;
    }

    .subtitle {
      color: #2A4A4A;
      font-size: 14px;
      margin-top: 5px;
      letter-spacing: 1px;
    }

    .info-box {
      background: rgba(232, 182, 92, 0.1);
      border: 1px solid #E8B65C;
      border-radius: 6px;
      padding: 20px;
      font-size: 14px;
      margin: 25px 0;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    form {
      margin-top: 30px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    label {
      display: block;
      margin: 25px 0 10px;
      font-weight: 600;
      color: #FFFFFF;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 14px;
      border-radius: 6px;
      border: 1px solid #2A4A4A;
      background: rgba(42, 74, 74, 0.2);
      color: #F5E5C8;
      font-size: 15px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    select {
      position: relative;
      z-index: 10;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23E8B65C' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 12px;
      padding-right: 40px;
      cursor: pointer;
    }

    select option {
      background-color: #0D0F15;
      color: #F5E5C8;
      padding: 12px;
      font-size: 15px;
    }

    select:focus { outline: none; border-color: #D88B5C; }
    input:focus, textarea:focus { outline: none; border-color: #D88B5C; }

    input::placeholder, textarea::placeholder { color: #7A8C9C; }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .checkbox-group {
      margin-top: 35px;
      padding: 20px;
      background-color: rgba(42, 74, 74, 0.1);
      border-radius: 6px;
      border: 1px solid #2A4A4A;
    }

    .checkbox-group label {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      font-weight: normal;
      color: #F5E5C8;
      margin: 15px 0;
      padding: 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
    }

    .button-container {
      margin-top: 40px;
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid #2A4A4A;
    }

    .button {
      display: inline-block;
      padding: 16px 40px;
      background: #E8B65C;
      color: #1A2838;
      font-size: 16px;
      font-weight: 700;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.3s ease;
      text-align: center;
      min-width: 220px;
    }

    .button:hover { opacity: 0.7; }
    .button:disabled { cursor: not-allowed; opacity: 0.6; }

    .note {
      margin-top: 20px;
      font-size: 13px;
      color: #2A4A4A;
      text-align: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .loading {
      display: none;
      margin-top: 15px;
    }

    .loading-spinner {
      border: 3px solid rgba(42, 74, 74, 0.3);
      border-top: 3px solid #E8B65C;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    footer {
      margin-top: 60px;
      padding: 40px 20px;
      text-align: center;
      font-size: 0.9rem;
      color: #2A4A4A;
      border-top: 1px solid #2A4A4A;
      background: #0D0F15;
    }

    .footer-content { max-width: 800px; margin: 0 auto; }

    .footer-links {
      margin: 25px 0;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .footer-links a {
      color: #2A4A4A;
      font-size: 0.85rem;
      text-decoration: none;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      color: #D88B5C;
      text-decoration: none;
    }

    .footer-copyright {
      color: #2A4A4A;
      margin-bottom: 20px;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .footer-title {
      color: #F5E5C8;
      margin-bottom: 10px;
      font-size: 0.95rem;
      font-weight: 600;
    }

    strong { color: #FFFFFF; font-weight: 600; }

    .section-divider {
      height: 1px;
      background-color: #2A4A4A;
      margin: 40px auto;
      max-width: 800px;
    }

    .follow-section {
      text-align: center;
      margin: 50px auto 30px;
      max-width: 800px;
    }

    .follow-section h2 {
      margin-bottom: 30px;
      border: none;
      padding-bottom: 0;
    }

    .social-icons {
      display: flex;
      justify-content: center;
      gap: 40px;
      flex-wrap: wrap;
    }

    .social-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.3s ease;
    }

    .social-icon:hover { transform: translateY(-5px); }

    .social-icon a {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
    }

    .icon-container {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #2A4A4A;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      transition: background-color 0.3s ease;
    }

    .social-icon:hover .icon-container { background: #D88B5C; }

    .social-icon span {
      color: #F5E5C8;
      font-size: 14px;
      font-weight: 500;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .social-icons { gap: 30px; }
      .icon-container { width: 60px; height: 60px; }
    }

    @media (max-width: 480px) {
      .social-icons { gap: 20px; }
      .icon-container { width: 50px; height: 50px; }
    }
  </style>
</head>

<body>
  <header>
    <a href="https://caspergrenander.github.io/historienbakomusiken/projekt-info/">
      <img src="/historienbakomusiken/historienbakomusiken/assets/logo.png" alt="Historien Bakom Musiken Logo">
      <h1>Historien Bakom Musiken</h1>
    </a>
    <p class="subtitle">Data Deletion Request – AutoPublisher</p>
  </header>

  <div class="container">
    <h2>About Data Deletion</h2>
    <p>You have the right to request deletion of data processed in connection with <strong>Historien Bakom Musiken – AutoPublisher</strong>.</p>
    <p>This request applies only to data processed by AutoPublisher. Data managed directly by TikTok must be handled through TikTok's own account settings.</p>

    <div class="section-divider"></div>

    <div class="info-box">
      <strong>Processing time:</strong> The process is usually completed within <strong>7–10 business days</strong> after the request is received.
    </div>

    <div class="section-divider"></div>

    <h2>Request Data Deletion</h2>

    <!-- Dold iframe för att hantera formulärinlämning -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <!--
      GOOGLE FORMS CONFIGURATION VALIDATION:
      - Form Action URL: https://docs.google.com/forms/d/e/1FAIpQLSfIlZrBcx1CgAu-cHCGzr-Mw7gxqPpB3mMwnNDnr-eOG10jLQ/formResponse
      - Method: POST
      - Target: hidden_iframe (for silent submission)
      
      FIELD MAPPINGS (entry.* keys must match Google Form field IDs):
      - entry.1526351014: Request ID (auto-generated reference)
      - entry.1745207114: Submission Source (hidden: "Public Website – Data Deletion Page")
      - entry.1000001577: Full name
      - entry.1233888397: Email address
      - entry.531571766: TikTok username
      - entry.1847505465: Type of request (dropdown)
      - entry.226762827: Additional information (optional)
      - entry.977425461: Confirm owner checkbox
      - entry.246601893: Confirm undo checkbox
      
      SUBMISSION STRATEGY:
      - Dual submission: iframe (primary) + fetch (backup)
      - Retry mechanism: Up to 3 attempts with exponential backoff
      - Logging: All attempts logged to console and sessionStorage
    -->

    <form id="dataDeletionForm"
          method="POST"
          action="https://docs.google.com/forms/d/e/1FAIpQLSfIlZrBcx1CgAu-cHCGzr-Mw7gxqPpB3mMwnNDnr-eOG10jLQ/formResponse"
          target="hidden_iframe"
          autocomplete="on">

      <!-- Google Forms hidden fields -->
      <input type="hidden" name="fvv" value="1">
      <input type="hidden" name="draftResponse" value="[]">
      <input type="hidden" name="pageHistory" value="0">
      <input type="hidden" name="fbzx" value="-2437333437311568305">

      <!-- Custom hidden fields -->
      <input type="hidden" id="requestId" name="entry.1526351014" value="">
      <input type="hidden" id="submissionSource" name="entry.1745207114" value="Public Website – Data Deletion Page">

      <!-- Visible form fields -->
      <label>Full name</label>
      <input type="text" name="entry.1000001577" placeholder="Your full name" required>

      <label>Email address</label>
      <input type="email" name="entry.1233888397" placeholder="you@example.com" required>

      <label>TikTok username</label>
      <input type="text" name="entry.531571766" placeholder="@yourusername" required>

      <label>Type of request</label>
      <select id="requestType" name="entry.1847505465" required>
        <option value="" disabled selected>Select request type</option>
        <option value="Delete all data related to my account">Delete all data related to my account</option>
        <option value="Delete uploaded video metadata">Delete uploaded video metadata</option>
        <option value="Revoke access & delete authentication tokens">Revoke access & delete authentication tokens</option>
      </select>

      <label>Additional information (optional)</label>
      <textarea name="entry.226762827" placeholder="Optional comments or clarification"></textarea>

      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="confirmOwner" name="entry.977425461" value="I confirm that I am the owner of the TikTok account listed above." required>
          I confirm that I am the owner of the TikTok account listed above.
        </label>

        <label>
          <input type="checkbox" id="confirmUndo" name="entry.246601893" value="I understand that this request cannot be undone." required>
          I understand that this request cannot be undone.
        </label>
      </div>

      <div class="button-container">
        <button class="button" id="submitBtn" type="submit" disabled>Request Data Deletion</button>
        
        <div class="loading" id="loadingIndicator">
          <div class="loading-spinner"></div>
          <p style="margin-top: 10px; color: #E8B65C;">Submitting your request...</p>
          <p style="margin-top: 5px; font-size: 12px; color: #7A8C9C;">Using multiple submission methods for reliability</p>
        </div>

        <div class="note" id="submitNote">
          Your request will be submitted to our system. Please don't close this page while submitting.
        </div>

        <div id="successMessage" class="note" style="display:none; font-size:14px; margin-top:18px; color: #4CAF50;">
          ✅ Request successfully submitted. Redirecting to confirmation page...
        </div>

        <div id="errorMessage" class="note" style="display:none; font-size:14px; margin-top:18px; color: #f44336;">
          ❌ An error occurred. Please try again or contact support.
        </div>
      </div>
    </form>

    <div class="follow-section">
      <h2>Follow Us</h2>
      <div class="social-icons">

        <div class="social-icon">
          <a href="https://www.instagram.com/historienbakommusiken?igsh=MXhkcXp6a2J1MjN6NQ==" target="_blank" rel="noopener noreferrer">
            <div class="icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                <path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6-7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/>
              </svg>
            </div>
            <span>Instagram</span>
          </a>
        </div>

        <div class="social-icon">
          <a href="https://www.facebook.com/share/17mCscac1o/" target="_blank" rel="noopener noreferrer">
            <div class="icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/>
              </svg>
            </div>
            <span>Facebook</span>
          </a>
        </div>

        <div class="social-icon">
          <a href="https://open.spotify.com/show/4iNHYPETp0acYF9bdagB2B?si=tSNgfmGxR_iUJwPIeLRJig" target="_blank" rel="noopener noreferrer">
            <div class="icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
                <path fill="currentColor" d="M248 8C111.1 8 0 119.1 0 256s111.1 248 248 248 248-111.1 248-248S384.9 8 248 8zm100.7 364.9c-4.2 0-6.8-1.3-10.7-3.6-62.4-37.6-135-39.2-206.7-24.5-3.9 1-9 2.6-11.9 2.6-9.7 0-15.8-7.7-15.8-15.8 0-10.3 6.1-15.2 13.6-16.8 81.9-18.1 165.6-16.5 237 26.2 6.1 3.9 9.7 7.4 9.7 16.5s-7.1 15.4-15.2 15.4zm26.9-65.6c-5.2 0-8.7-2.3-12.3-4.2-62.5-37-155.7-51.9-238.6-29.4-4.8 1.3-7.4 2.6-11.9 2.6-10.7 0-19.4-8.7-19.4-19.4s5.2-17.8 15.5-20.7c27.8-7.8 56.2-13.6 97.8-13.6 64.9 0 127.6 16.1 177 45.5 8.1 4.8 11.3 11 11.3 19.7-.1 10.8-8.5 19.5-19.4 19.5zm31-76.2c-5.2 0-8.4-1.3-12.9-3.9-71.2-42.5-198.5-52.7-280.9-29.7-3.6 1-8.1 2.6-12.9 2.6-13.2 0-23.3-10.3-23.3-23.6 0-13.6 8.4-21.3 17.4-23.9 35.2-10.3 74.6-15.2 117.5-15.2 73 0 149.5 15.2 205.4 47.8 7.8 4.5 12.9 10.7 12.9 22.6 0 13.6-11 23.3-23.2 23.3z"/>
              </svg>
            </div>
            <span>Spotify</span>
          </a>
        </div>

        <div class="social-icon">
          <a href="https://www.tiktok.com/@historienbakommusiken?_r=1&_t=ZN-92stjEInvde" target="_blank" rel="noopener noreferrer">
            <div class="icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                <path fill="currentColor" d="M448,209.91a210.06,210.06,0,0,1-122.77-39.25V349.38A162.55,162.55,0,1,1,185,188.31V278.2a74.62,74.62,0,1,0,52.23,71.18V0l88,0a121.18,121.18,0,0,0,1.86,22.17h0A122.18,122.18,0,0,0,381,102.39a121.43,121.43,0,0,0,67,20.14Z"/>
              </svg>
            </div>
            <span>TikTok</span>
          </a>
        </div>

      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p class="footer-title">Historien Bakom Musiken – AutoPublisher</p>
      <p class="footer-copyright">© 2026 Casper Grenander. All rights reserved.</p>
      <div class="footer-links">
        <a href="https://caspergrenander.github.io/historienbakomusiken/projekt-info/">Home</a>
        <a href="https://caspergrenander.github.io/historienbakomusiken/terms-of-service">Terms of Service</a>
        <a href="https://caspergrenander.github.io/historienbakomusiken/privacy-policy">Privacy Policy</a>
        <a href="https://caspergrenander.github.io/historienbakomusiken/data%20deletion">Data Deletion</a>
        <a href="https://caspergrenander.github.io/historienbakomusiken/contact">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Element referenser
      const form = document.getElementById('dataDeletionForm');
      const requestIdField = document.getElementById('requestId');
      const confirmOwner = document.getElementById('confirmOwner');
      const confirmUndo = document.getElementById('confirmUndo');
      const submitBtn = document.getElementById('submitBtn');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      const submitNote = document.getElementById('submitNote');

      // Enhanced logging system
      const SubmissionLogger = {
        logs: [],
        log: function(level, message, data = {}) {
          const logEntry = {
            timestamp: new Date().toISOString(),
            level: level,
            message: message,
            data: data
          };
          this.logs.push(logEntry);
          console.log(`[${level.toUpperCase()}] ${message}`, data);
          
          // Store logs in sessionStorage for debugging
          try {
            sessionStorage.setItem('formSubmissionLogs', JSON.stringify(this.logs));
          } catch (e) {
            console.error('Error saving logs to sessionStorage:', e);
          }
        },
        getLogs: function() {
          return this.logs;
        }
      };

      // Generera och spara Reference ID
      function generateReferenceId() {
        const year = new Date().getFullYear();
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(1000 + Math.random() * 9000);
        return `DR-${year}-${timestamp}-${random}`;
      }

      // Spara Reference ID i local storage
      function saveReferenceIdToLocalStorage(referenceId) {
        try {
          localStorage.setItem('dataDeletionReferenceId', referenceId);
          localStorage.setItem('lastDataDeletionRequest', JSON.stringify({
            referenceId: referenceId,
            timestamp: new Date().toISOString(),
            status: 'pending',
            submissionAttempts: 0
          }));
          
          SubmissionLogger.log('info', 'Reference ID saved to localStorage', { referenceId });
          return true;
        } catch (error) {
          SubmissionLogger.log('error', 'Error saving to localStorage', { error: error.message });
          return false;
        }
      }

      // Initialisera Reference ID
      let referenceId;
      
      // Försök att hämta befintligt ID från local storage
      try {
        const savedData = localStorage.getItem('lastDataDeletionRequest');
        if (savedData) {
          const parsedData = JSON.parse(savedData);
          const requestTime = new Date(parsedData.timestamp);
          const now = new Date();
          const hoursDiff = Math.abs(now - requestTime) / 36e5;
          
          if (hoursDiff < 24 && parsedData.status === 'pending') {
            referenceId = parsedData.referenceId;
            SubmissionLogger.log('info', 'Reusing existing Reference ID', { referenceId, age: hoursDiff.toFixed(2) + 'h' });
          } else {
            referenceId = generateReferenceId();
            saveReferenceIdToLocalStorage(referenceId);
            SubmissionLogger.log('info', 'Generated new Reference ID (old one expired or completed)', { referenceId });
          }
        } else {
          referenceId = generateReferenceId();
          saveReferenceIdToLocalStorage(referenceId);
          SubmissionLogger.log('info', 'Generated new Reference ID (first time)', { referenceId });
        }
      } catch (e) {
        referenceId = generateReferenceId();
        saveReferenceIdToLocalStorage(referenceId);
        SubmissionLogger.log('error', 'Error loading saved data, generated new ID', { error: e.message, referenceId });
      }

      // Sätt Reference ID i formuläret
      if (requestIdField && referenceId) {
        requestIdField.value = referenceId;
        SubmissionLogger.log('info', 'Reference ID set in form field', { referenceId });
      }

      // Aktivera/inaktivera submit-knapp
      function updateButtonState() {
        const isConfirmed = confirmOwner.checked && confirmUndo.checked;
        submitBtn.disabled = !isConfirmed;
        submitBtn.style.opacity = isConfirmed ? '1' : '0.6';
      }

      confirmOwner.addEventListener('change', updateButtonState);
      confirmUndo.addEventListener('change', updateButtonState);
      updateButtonState();

      // Track submission attempts
      let submissionAttempts = 0;
      const MAX_RETRY_ATTEMPTS = 3;
      let iframeSubmissionCompleted = false;
      let fetchSubmissionCompleted = false;

      // Dual submission strategy: iframe + fetch with retry
      function submitFormWithRetry(attempt = 1) {
        SubmissionLogger.log('info', `Submission attempt ${attempt}/${MAX_RETRY_ATTEMPTS}`, { referenceId });
        submissionAttempts = attempt;

        // Update attempt counter in localStorage
        try {
          const savedData = localStorage.getItem('lastDataDeletionRequest');
          if (savedData) {
            const parsedData = JSON.parse(savedData);
            parsedData.submissionAttempts = attempt;
            localStorage.setItem('lastDataDeletionRequest', JSON.stringify(parsedData));
          }
        } catch (e) {
          SubmissionLogger.log('error', 'Error updating attempt counter', { error: e.message });
        }

        // Prepare form data
        const formData = new FormData(form);
        
        SubmissionLogger.log('info', 'Form data prepared', {
          entryCount: Array.from(formData.entries()).length,
          referenceId: formData.get('entry.1526351014')
        });

        // Strategy 1: Submit via iframe (more reliable for Google Forms)
        try {
          form.target = 'hidden_iframe';
          form.submit();
          SubmissionLogger.log('info', 'Iframe submission initiated', { attempt });
        } catch (error) {
          SubmissionLogger.log('error', 'Iframe submission failed', { error: error.message, attempt });
        }

        // Strategy 2: Submit via fetch as backup (parallel submission)
        fetch(form.action, {
          method: 'POST',
          body: formData,
          mode: 'no-cors'
        })
        .then(() => {
          fetchSubmissionCompleted = true;
          SubmissionLogger.log('success', 'Fetch submission completed', { attempt });
          
          // Wait a bit to see if iframe also completes
          setTimeout(() => {
            if (!iframeSubmissionCompleted && !fetchSubmissionCompleted) {
              SubmissionLogger.log('warning', 'Neither submission method confirmed, but likely succeeded');
            }
            handleSuccessfulSubmission();
          }, 2000);
        })
        .catch((error) => {
          SubmissionLogger.log('error', 'Fetch submission failed', { error: error.message, attempt });
          
          // Retry if attempts remaining
          if (attempt < MAX_RETRY_ATTEMPTS) {
            const retryDelay = Math.min(1000 * Math.pow(2, attempt - 1), 5000); // Exponential backoff: 1s, 2s, 4s
            SubmissionLogger.log('info', `Retrying in ${retryDelay}ms`, { attempt: attempt + 1 });
            
            setTimeout(() => {
              submitFormWithRetry(attempt + 1);
            }, retryDelay);
          } else {
            SubmissionLogger.log('error', 'All submission attempts exhausted', { attempts: MAX_RETRY_ATTEMPTS });
            handleSubmissionFailure();
          }
        });
      }

      // Handle successful submission
      function handleSuccessfulSubmission() {
        SubmissionLogger.log('success', 'Form submission successful', { 
          referenceId,
          attempts: submissionAttempts,
          iframeCompleted: iframeSubmissionCompleted,
          fetchCompleted: fetchSubmissionCompleted
        });
        
        // Update localStorage status
        try {
          const savedData = localStorage.getItem('lastDataDeletionRequest');
          if (savedData) {
            const parsedData = JSON.parse(savedData);
            parsedData.status = 'submitted';
            parsedData.submittedAt = new Date().toISOString();
            parsedData.submissionAttempts = submissionAttempts;
            localStorage.setItem('lastDataDeletionRequest', JSON.stringify(parsedData));
          }
        } catch (e) {
          SubmissionLogger.log('error', 'Error updating localStorage', { error: e.message });
        }
        
        // Show success message
        loadingIndicator.style.display = 'none';
        errorMessage.style.display = 'none';
        successMessage.style.display = 'block';
        
        // Redirect to confirmation page
        setTimeout(() => {
          const redirectUrl = `https://caspergrenander.github.io/historienbakomusiken/request-received?ref=${encodeURIComponent(referenceId)}`;
          SubmissionLogger.log('info', 'Redirecting to confirmation page', { url: redirectUrl });
          window.location.href = redirectUrl;
        }, 2000);
      }

      // Handle submission failure
      function handleSubmissionFailure() {
        SubmissionLogger.log('error', 'Form submission failed after all retries', { 
          referenceId,
          attempts: submissionAttempts
        });
        
        loadingIndicator.style.display = 'none';
        successMessage.style.display = 'none';
        errorMessage.style.display = 'block';
        errorMessage.innerHTML = '❌ Unable to submit your request after multiple attempts. Please try again later or contact support with Reference ID: ' + referenceId;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Request Data Deletion';
      }

      // Hantera formulärinlämning
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        
        SubmissionLogger.log('info', 'Form submission initiated', { referenceId });
        
        // Show loading indicator
        loadingIndicator.style.display = 'block';
        submitNote.style.display = 'none';
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // Validate checkboxes
        if (!confirmOwner.checked || !confirmUndo.checked) {
          SubmissionLogger.log('warning', 'Validation failed: checkboxes not confirmed');
          alert('Please confirm both checkboxes before submitting.');
          loadingIndicator.style.display = 'none';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Request Data Deletion';
          return;
        }

        SubmissionLogger.log('info', 'Validation passed, starting dual submission strategy');
        
        // Start submission with retry mechanism
        submitFormWithRetry(1);
      });

      // Listen for iframe load events
      const iframe = document.getElementById('hidden_iframe');
      iframe.addEventListener('load', function() {
        // Only count as success if we've actually submitted
        if (submissionAttempts > 0) {
          iframeSubmissionCompleted = true;
          SubmissionLogger.log('success', 'Iframe loaded - form submission completed', { 
            attempt: submissionAttempts 
          });
        }
      });

      // Log initial page load
      SubmissionLogger.log('info', 'Data deletion form initialized', {
        referenceId,
        formAction: form.action,
        timestamp: new Date().toISOString()
      });
    });
  </script>
</body>
</html>